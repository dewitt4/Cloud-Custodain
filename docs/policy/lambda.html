

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lambda Support &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/c1_labs.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/expand.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Cloud Custodian  documentation" href="../index.html"/>
        <link rel="next" title="Mu - Lambda Lifecycle Management" href="mu.html"/>
        <link rel="prev" title="Tag Compliance Across Resources (EC2, ASG, ELB, S3, etc)" href="../usecases/usecases/tagcompliance.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/usage.html">Monitoring your environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/offhours.html">Example offhours policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/tagCompliance.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecases/index.html">Use Cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AWS Lambda</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lambda Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cloudwatch-events">CloudWatch Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cloud-custodian-integration">Cloud Custodian Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Policies reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Resource-Specific Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer Install and Testing</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../generated/modules.html">c7n</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Cloud Custodian</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Lambda Support</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lambda-support">
<span id="lambda"></span><h1>Lambda Support<a class="headerlink" href="#lambda-support" title="Permalink to this headline">¶</a></h1>
<p>Lambda provides for powerful realtime event based code execution in
response to infrastructure and application behavior. A number of
different Amazon services can be used as event sources.</p>
<div class="section" id="cloudwatch-events">
<h2>CloudWatch Events<a class="headerlink" href="#cloudwatch-events" title="Permalink to this headline">¶</a></h2>
<p>CloudWatch Events (CWE) is a general event bus for AWS infrastructure. Currently,
it covers several major sources of information: CloudTrail API calls
over a poll period on CloudTrail delivery, real-time instance status
events, autoscale group notifications, and scheduled/periodic events.</p>
<p>CloudTrail provides a very rich data source over the entire range
of AWS services exposed via the audit trail that allows Custodian to define effective
realtime policies against any AWS product.</p>
<p>Additionally, for EC2 instances we can provide mandatory policy
compliance - this means the non-compliant resources never
became available.</p>
</div>
<div class="section" id="cloud-custodian-integration">
<h2>Cloud Custodian Integration<a class="headerlink" href="#cloud-custodian-integration" title="Permalink to this headline">¶</a></h2>
<p>Custodian provides for policy level execution against any CWE event
stream. Each Custodian policy can be deployed as an independent Lambda
function. The only difference between a Custodian policy that runs in
Lambda and one that runs directly from the CLI in poll mode
is the specification of the subscription of the events in the mode config block of the policy.</p>
<p>Internally Custodian will reconstitute current state for all the resources
in the event, execute the policy against them, match against the
policy filters, and apply the policy actions to matching resources.</p>
<p><a class="reference internal" href="mu.html#mu"><span class="std std-ref">Mu</span></a> is the letter after Lambda, Lambda is a keyword in python.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Examples</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>

  <span class="c1"># Cloud Watch Events over CloudTrail api calls (1-15m trailing)</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2-tag-compliance</span>
    <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2</span>

    <span class="c1"># The mode block is the only difference between a Custodian policy that</span>
    <span class="c1"># runs in reactive/push mode via lambda and one that runs in poll mode.</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloudtrail</span>
      <span class="l l-Scalar l-Scalar-Plain">events</span><span class="p p-Indicator">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">RunInstances</span>

      <span class="c1"># Note because the total AWS API surface area is so large</span>
      <span class="c1"># most CloudTrail API event subscriptions need two additional</span>
      <span class="c1"># fields.</span>
      <span class="c1">#</span>
      <span class="c1"># For CloudTrail events we need to reference the source API call</span>
      <span class="c1"># sources:</span>
      <span class="c1">#  - ec2.amazonaws.com</span>
      <span class="c1">#</span>
      <span class="c1"># To work transparently with existing resource policies, we also</span>
      <span class="c1"># need to specify how to extract the resource IDs from the event</span>
      <span class="c1"># via JMESPath so that the resources can be queried.</span>
      <span class="c1"># IDs: &quot;detail.responseElements.instancesSet.items[].instanceId&quot;</span>
      <span class="c1">#</span>
      <span class="c1"># For very common API calls for policies, some shortcuts have</span>
      <span class="c1"># been defined to allow for easier policy writing as for the</span>
      <span class="c1"># RunInstances API call above.</span>
      <span class="c1">#</span>

    <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag:required1</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag:required2</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
    <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stop</span>

  <span class="c1"># On EC2 Instance state events (real time, seconds)</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2-require-encrypted-volumes</span>
    <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2-instance-state</span>
      <span class="l l-Scalar l-Scalar-Plain">events</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pending</span>
    <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ebs</span>
        <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Encrypted</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
    <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mark</span>
      <span class="c1"># TODO delete instance volumes that</span>
      <span class="c1"># are not set to delete on terminate;</span>
      <span class="c1"># currently we have a poll policy that</span>
      <span class="c1"># handles this.</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">terminate</span>

  <span class="c1"># Periodic Function</span>
  <span class="c1"># Syntax for scheduler per http://goo.gl/x3oMQ4</span>
  <span class="c1"># Supports both rate per unit time and cron expressions</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s3-bucket-check</span>
    <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">periodic</span>
      <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&quot;rate(1</span><span class="nv"> </span><span class="s">day)&quot;</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mu.html" class="btn btn-neutral float-right" title="Mu - Lambda Lifecycle Management" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../usecases/usecases/tagcompliance.html" class="btn btn-neutral" title="Tag Compliance Across Resources (EC2, ASG, ELB, S3, etc)" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Capital One Services, LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/js/expand.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>