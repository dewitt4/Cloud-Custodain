

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Azure Functions Support &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/c1_labs.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/expand.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Advanced Usage" href="multiplesubs.html" />
    <link rel="prev" title="Advanced Usage" href="index.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/advanced.html">Advanced Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/offhours.html">Example offhours policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/tagCompliance.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AWS Lambda</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Policies reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../policy/index.html">Resource-Specific Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters.html">Generic Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/tests.html">Testing for Developers</a></li>
</ul>
<p class="caption"><span class="caption-text">Azure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policy/index.html">Policies</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced Usage</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Azure Functions Support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#provision-options">Provision Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#execution-options">Execution Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-grid-functions">Event Grid Functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="multiplesubs.html">Advanced Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="bloboutput.html">Blob Storage Output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/aws/modules.html">AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/azure/modules.html">Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gcp/modules.html">GCP</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Custodian</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Advanced Usage</a> &raquo;</li>
        
      <li>Azure Functions Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="azure-functions-support">
<span id="azure-azurefunctions"></span><h1>Azure Functions Support<a class="headerlink" href="#azure-functions-support" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Azure provider supports deploying policies into Azure Functions to allow
them to run inexpensively in your subscription.</p>
<p>Python support in Azure Functions V2 is in preview and this feature is still immature.</p>
<ul class="simple">
<li>Linux is currently the only supported operating system.</li>
<li>Python 3.6 is the only supported version.</li>
<li>Only Service Principal authentication is currently supported.</li>
</ul>
<p>Currently periodic (CRON) and Event Grid functions are supported, however consumption pricing is not
yet supported.</p>
<div class="section" id="provision-options">
<h3>Provision Options<a class="headerlink" href="#provision-options" title="Permalink to this headline">¶</a></h3>
<p>When deploying an Azure function the following ARM resources are required and created on demand:</p>
<ul class="simple">
<li>Storage (shared across functions)</li>
<li>Application Insights (shared across functions)</li>
<li>Application Service Plan (shared across functions)</li>
<li>Application Service (per function)</li>
</ul>
<p>A single Application Service Plan (Basic, Standard or Premium) can service a large number
of Application Service Instances.  If you provide the same servicePlanName with all policies or
use the default name then only new Applications will be created during deployment, all using the same
shared plan resources.</p>
<p>Execution in Azure functions comes with a default set of configurations for the provisioned
resources. To override these settings you must set ‘provision-options’ with one of the following
keys:</p>
<ul class="simple">
<li>location (default: West US 2)</li>
<li>appInsightsLocation (default: West US 2)</li>
<li>servicePlanName (default: cloud-custodian)</li>
<li>sku (default: Basic)</li>
<li>skuCode (default: B1)</li>
<li>workerSize (default: 0)</li>
</ul>
<p>The location allows you to choose the region to deploy the resource group and resources that will be
provisioned. Application Insights has six available locations and thus can not always be in the same
region as the other resources: West US 2, East US, North Europe, South Central US, Southeast Asia, and
West Europe. The sku, skuCode, and workerSize correlate to scaling up the App Service Plan.</p>
<p>An example on how to set the servicePlanName and accept defaults for the other values:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">provision-options</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">servicePlanName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
    <span class=" -Error"> </span><span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
<p>An example on how to set size and location as well:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">provision-options</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">servicePlanName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
          <span class="l l-Scalar l-Scalar-Plain">location</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">East US</span>
          <span class="l l-Scalar l-Scalar-Plain">appInsightsLocation</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">East US</span>
          <span class="l l-Scalar l-Scalar-Plain">sku</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard</span>
          <span class="l l-Scalar l-Scalar-Plain">skuCode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">S1</span>
    <span class=" -Error"> </span><span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="execution-options">
<h3>Execution Options<a class="headerlink" href="#execution-options" title="Permalink to this headline">¶</a></h3>
<p>Execution options are not required, but allow you to override defaults that would normally
be provided on the command line in non-serverless scenarios.</p>
<p>Common properties are:</p>
<ul class="simple">
<li>output_dir</li>
<li>cache_period</li>
<li>dryrun</li>
</ul>
<p>Output directory defaults to <cite>/tmp/&lt;random_uuid&gt;</cite> but you can point it to a Azure Blob Storage container instead</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">provision-options</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">servicePlanName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
        <span class="l l-Scalar l-Scalar-Plain">execution-options</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">output_dir</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure://yourstorageaccount.blob.core.windows.net/custodian</span>
    <span class=" -Error"> </span><span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
<p>More details on Blob Storage output are at <a class="reference internal" href="bloboutput.html#azure-bloboutput"><span class="std std-ref">Blob Storage Output</span></a></p>
</div>
<div class="section" id="event-grid-functions">
<h3>Event Grid Functions<a class="headerlink" href="#event-grid-functions" title="Permalink to this headline">¶</a></h3>
<p>Currently, support for event grid functions is at the subscription level and can listen to write and delete
events. When deploying an event grid function, an Event Grid Subscription is created that triggers the Azure Function
when any event is triggered in the subscription. Cloud custodian filters to the events you passed to your policy and
ignores all other events.</p>
<p>In order to subscribe on an event you need to provide the resource provider and the action, or provide the string
of one of the <a class="reference external" href="https://github.com/capitalone/cloud-custodian/blob/master/tools/c7n_azure/c7n_azure/azure_events.py">shortcuts</a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tag-key-vault-creator</span>
      <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.keyvault</span>
      <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-event-grid</span>
        <span class="l l-Scalar l-Scalar-Plain">events</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[{</span>
            <span class="nv">resourceProvider</span><span class="p p-Indicator">:</span> <span class="s">&#39;Microsoft.KeyVault/vaults&#39;</span><span class="p p-Indicator">,</span>
            <span class="nv">event</span><span class="p p-Indicator">:</span> <span class="s">&#39;write&#39;</span>
          <span class="p p-Indicator">}]</span>
      <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorEmail&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
      <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">auto-tag-user</span>
          <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CreatorEmail</span>
          <span class="l l-Scalar l-Scalar-Plain">days</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="multiplesubs.html" class="btn btn-neutral float-right" title="Advanced Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Advanced Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/expand.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>