.. _aws.rds:

aws.rds
=======

Resource manager for RDS DB instances.
    

Filters
-------


  - :ref:`config-compliance <aws.common.filters.config-compliance>`
  
  - :ref:`db-parameter <aws.rds.filters.db-parameter>`

  - :ref:`default-vpc <aws.rds.filters.default-vpc>`

  - :ref:`event <aws.common.filters.event>`
  
  - :ref:`finding <aws.common.filters.finding>`
  
  - :ref:`health-event <aws.common.filters.health-event>`
  
  - :ref:`kms-alias <aws.rds.filters.kms-alias>`

  - :ref:`marked-for-op <aws.common.filters.marked-for-op>`
  
  - :ref:`metrics <aws.common.filters.metrics>`
  
  - :ref:`network-location <aws.common.filters.network-location>`
  
  - :ref:`offhour <aws.common.filters.offhour>`
  
  - :ref:`onhour <aws.common.filters.onhour>`
  
  - :ref:`ops-item <aws.common.filters.ops-item>`
  
  - :ref:`security-group <aws.common.filters.security-group>`
  
  - :ref:`subnet <aws.common.filters.subnet>`
  
  - :ref:`tag-count <aws.common.filters.tag-count>`
  
  - :ref:`upgrade-available <aws.rds.filters.upgrade-available>`

  - :ref:`value <aws.common.filters.value>`
  
  - :ref:`vpc <aws.common.filters.vpc>`
  


.. _aws.rds.filters.db-parameter:

db-parameter
++++++++++++
Applies value type filter on set db parameter values.
:example:

.. code-block:: yaml

        policies:
          - name: rds-pg
            resource: rds
            filters:
              - type: db-parameter
                key: someparam
                op: eq
                value: someval

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - db-parameter
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
        - version
    required:
    - type


.. _aws.rds.filters.default-vpc:

default-vpc
+++++++++++
Matches if an rds database is in the default vpc

:example:

.. code-block:: yaml

        policies:
          - name: default-vpc-rds
            resource: rds
            filters:
              - type: default-vpc

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - default-vpc
    required:
    - type


.. _aws.rds.filters.kms-alias:

kms-alias
+++++++++


.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - kms-alias
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
        - version
    required:
    - type


.. _aws.rds.filters.upgrade-available:

upgrade-available
+++++++++++++++++
Scan DB instances for available engine upgrades

This will pull DB instances & check their specific engine for any
engine version with higher release numbers than the current one

This will also annotate the rds instance with 'target_engine' which is
the most recent version of the engine available

:example:

.. code-block:: yaml

        policies:
          - name: rds-upgrade-available
            resource: rds
            filters:
              - type: upgrade-available
                major: False

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      major:
        type: boolean
      type:
        enum:
        - upgrade-available
      value:
        type: boolean
    required:
    - type




Actions
-------


  - :ref:`auto-patch <aws.rds.actions.auto-patch>`

  - :ref:`auto-tag-user <aws.common.actions.auto-tag-user>`
  
  - :ref:`delete <aws.rds.actions.delete>`

  - :ref:`invoke-lambda <aws.common.actions.invoke-lambda>`
  
  - :ref:`invoke-sfn <aws.common.actions.invoke-sfn>`
  
  - :ref:`mark-for-op <aws.common.actions.mark-for-op>`
  
  - :ref:`modify-db <aws.rds.actions.modify-db>`

  - :ref:`modify-security-groups <aws.common.actions.modify-security-groups>`
  
  - :ref:`notify <aws.common.actions.notify>`
  
  - :ref:`post-finding <aws.common.actions.post-finding>`
  
  - :ref:`post-item <aws.common.actions.post-item>`
  
  - :ref:`put-metric <aws.common.actions.put-metric>`
  
  - :ref:`remove-tag <aws.common.actions.remove-tag>`
  
  - :ref:`resize <aws.rds.actions.resize>`

  - :ref:`retention <aws.rds.actions.retention>`

  - :ref:`set-public-access <aws.rds.actions.set-public-access>`

  - :ref:`set-snapshot-copy-tags <aws.rds.actions.set-snapshot-copy-tags>`

  - :ref:`snapshot <aws.rds.actions.snapshot>`

  - :ref:`start <aws.rds.actions.start>`

  - :ref:`stop <aws.rds.actions.stop>`

  - :ref:`tag <aws.common.actions.tag>`
  
  - :ref:`tag-trim <aws.common.actions.tag-trim>`
  
  - :ref:`upgrade <aws.rds.actions.upgrade>`

  - :ref:`webhook <aws.common.actions.webhook>`
  



.. _aws.rds.actions.auto-patch:

auto-patch
++++++++++
Toggle AutoMinorUpgrade flag on RDS instance

'window' parameter needs to be in the format 'ddd:hh:mm-ddd:hh:mm' and
have at least 30 minutes between start & end time.
If 'window' is not specified, AWS will assign a random maintenance window
to each instance selected.

:example:

.. code-block:: yaml

        policies:
          - name: enable-rds-autopatch
            resource: rds
            filters:
              - AutoMinorVersionUpgrade: false
            actions:
              - type: auto-patch
                minor: true
                window: Mon:23:00-Tue:01:00

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      minor:
        type: boolean
      type:
        enum:
        - auto-patch
      window:
        type: string
    required:
    - type


.. _aws.rds.actions.delete:

delete
++++++
Deletes selected RDS instances

This will delete RDS instances. It is recommended to apply with a filter
to avoid deleting all RDS instances in the account.

:example:

.. code-block:: yaml

        policies:
          - name: rds-delete
            resource: rds
            filters:
              - default-vpc
            actions:
              - type: delete
                skip-snapshot: true

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      copy-restore-info:
        type: boolean
      skip-snapshot:
        type: boolean
      type:
        enum:
        - delete
    required:
    - type


.. _aws.rds.actions.modify-db:

modify-db
+++++++++
Modifies an RDS instance based on specified parameter
using ModifyDbInstance.

'Update' is an array with with key value pairs that should be set to
the property and value you wish to modify.
'Immediate" determines whether the modification is applied immediately
or not. If 'immediate' is not specified, default is false.

:example:

.. code-block:: yaml

        policies:
          - name: disable-rds-deletion-protection
            resource: rds
            filters:
              - DeletionProtection: true
              - PubliclyAccessible: true
            actions:
              - type: modify-db
                update:
                  - property: 'DeletionProtection'
                    value: false
                  - property: 'PubliclyAccessible'
                    value: false
                immediate: true

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      immediate:
        type: boolean
      type:
        enum:
        - modify-db
      update:
        items:
          properties:
            property:
              enum:
              - AllocatedStorage
              - DBInstanceClass
              - DBSubnetGroupName
              - DBSecurityGroups
              - VpcSecurityGroupIds
              - MasterUserPassword
              - DBParameterGroupName
              - BackupRetentionPeriod
              - PreferredBackupWindow
              - PreferredMaintenanceWindow
              - MultiAZ
              - EngineVersion
              - AllowMajorVersionUpgrade
              - AutoMinorVersionUpgrade
              - LicenseModel
              - Iops
              - OptionGroupName
              - NewDBInstanceIdentifier
              - StorageType
              - TdeCredentialArn
              - TdeCredentialPassword
              - CACertificateIdentifier
              - Domain
              - CopyTagsToSnapshot
              - MonitoringInterval
              - DBPortNumber
              - PubliclyAccessible
              - DomainIAMRoleName
              - PromotionTier
              - EnableIAMDatabaseAuthentication
              - EnablePerformanceInsights
              - PerformanceInsightsKMSKeyId
              - PerformanceInsightsRetentionPeriod
              - CloudwatchLogsExportConfiguration
              - UseDefaultProcessorFeatures
              - DeletionProtection
              type: string
            value: {}
          type: object
        type: array
    required:
    - update


.. _aws.rds.actions.resize:

resize
++++++
Change the allocated storage of an rds instance.

:example:

This will find databases using over 85% of their allocated
storage, and resize them to have an additional 30% storage
the resize here is async during the next maintenance.

.. code-block:: yaml

        policies:
          - name: rds-resize-up
            resource: rds
            filters:
              - type: metrics
                name: FreeStorageSpace
                percent-attr: AllocatedStorage
                attr-multiplier: 1073741824
                value: 90
                op: greater-than
            actions:
              - type: resize
                percent: 30


This will find databases using under 20% of their allocated
storage, and resize them to be 30% smaller, the resize here
is configured to be immediate.

.. code-block:: yaml

        policies:
          - name: rds-resize-down
            resource: rds
            filters:
              - type: metrics
                name: FreeStorageSpace
                percent-attr: AllocatedStorage
                attr-multiplier: 1073741824
                value: 90
                op: greater-than
            actions:
              - type: resize
                percent: -30
                immediate: true

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      immediate:
        type: boolean
      percent:
        type: number
      type:
        enum:
        - resize
    required:
    - type


.. _aws.rds.actions.retention:

retention
+++++++++
Sets the 'BackupRetentionPeriod' value for automated snapshots,
enforce (min, max, exact) sets retention days occordingly.
:example:

.. code-block:: yaml

        policies:
          - name: rds-snapshot-retention
            resource: rds
            filters:
              - type: value
                key: BackupRetentionPeriod
                value: 7
                op: lt
            actions:
              - type: retention
                days: 7
                copy-tags: true
                enforce: exact

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      copy-tags:
        type: boolean
      days:
        type: number
      enforce:
        enum:
        - min
        - max
        - exact
        type: string
      type:
        enum:
        - retention
    required:
    - type


.. _aws.rds.actions.set-public-access:

set-public-access
+++++++++++++++++
This action allows for toggling an RDS instance
'PubliclyAccessible' flag to true or false

:example:

.. code-block:: yaml

        policies:
          - name: disable-rds-public-accessibility
            resource: rds
            filters:
              - PubliclyAccessible: true
            actions:
              - type: set-public-access
                state: false

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      state:
        type: boolean
      type:
        enum:
        - set-public-access
    required:
    - type


.. _aws.rds.actions.set-snapshot-copy-tags:

set-snapshot-copy-tags
++++++++++++++++++++++
Enables copying tags from rds instance to snapshot

DEPRECATED - use modify-db instead with `CopyTagsToSnapshot`

:example:

    .. code-block:: yaml

        policies:
          - name: enable-rds-snapshot-tags
            resource: rds
            filters:
              - type: value
                key: Engine
                value: aurora
                op: eq
            actions:
              - type: set-snapshot-copy-tags
                enable: True

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      enable:
        type: boolean
      type:
        enum:
        - set-snapshot-copy-tags
    required:
    - type


.. _aws.rds.actions.snapshot:

snapshot
++++++++
Creates a manual snapshot of a RDS instance

:example:

.. code-block:: yaml

        policies:
          - name: rds-snapshot
            resource: rds
            actions:
              - snapshot

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - snapshot
    required:
    - type


.. _aws.rds.actions.start:

start
+++++
Start an rds instance.
    

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - start
    required:
    - type


.. _aws.rds.actions.stop:

stop
++++
Stop an rds instance.

https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_StopInstance.html

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - stop
    required:
    - type


.. _aws.rds.actions.upgrade:

upgrade
+++++++
Upgrades a RDS instance to the latest major/minor version available

Use of the 'immediate' flag (default False) will automatically upgrade
the RDS engine disregarding the existing maintenance window.

:example:

.. code-block:: yaml

        policies:
          - name: upgrade-rds-minor
            resource: rds
            actions:
              - type: upgrade
                major: False
                immediate: False

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      immediate:
        type: boolean
      major:
        type: boolean
      type:
        enum:
        - upgrade
    required:
    - type

