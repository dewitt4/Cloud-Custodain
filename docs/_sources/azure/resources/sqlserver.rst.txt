.. _azure.sqlserver:

azure.sqlserver
===============

SQL Server Resource

:example:

This policy will find all SQL servers with average DTU consumption under
10 percent over the last 72 hours

.. code-block:: yaml

    policies:
      - name: sqlserver-under-utilized
        resource: azure.sqlserver
        filters:
          - type: metric
            metric: dtu_consumption_percent
            op: lt
            aggregation: average
            threshold: 10
            timeframe: 72
            filter: "ElasticPoolResourceId eq '*'"
            no_data_action: include

:example:

This policy will find all SQL servers without any firewall rules defined.

.. code-block:: yaml

    policies:
      - name: find-sqlserver-without-firewall-rules
        resource: azure.sqlserver
        filters:
          - type: firewall-rules
            equal: []

:example:

This policy will find all SQL servers allowing traffic from 1.2.2.128/25 CIDR.

.. code-block:: yaml

    policies:
      - name: find-sqlserver-allowing-subnet
        resource: azure.sqlserver
        filters:
          - type: firewall-rules
            include: ['1.2.2.128/25']

Filters
-------


  - :ref:`cost <azure.common.filters.cost>`
  
  - :ref:`diagnostic-settings <azure.common.filters.diagnostic-settings>`
  
  - :ref:`event <azure.common.filters.event>`
  
  - :ref:`firewall-bypass <azure.sqlserver.filters.firewall-bypass>`

  - :ref:`firewall-rules <azure.common.filters.firewall-rules>`
  
  - :ref:`marked-for-op <azure.common.filters.marked-for-op>`
  
  - :ref:`metric <azure.common.filters.metric>`
  
  - :ref:`offhour <azure.common.filters.offhour>`
  
  - :ref:`onhour <azure.common.filters.onhour>`
  
  - :ref:`policy-compliant <azure.common.filters.policy-compliant>`
  
  - :ref:`resource-lock <azure.common.filters.resource-lock>`
  
  - :ref:`value <azure.common.filters.value>`
  


.. _azure.sqlserver.filters.firewall-bypass:

firewall-bypass
+++++++++++++++
Filters resources by the firewall bypass rules.

:example:

This policy will find all SQL Servers with enabled Azure Services bypass rules

.. code-block:: yaml

    policies:
      - name: sqlserver-bypass
        resource: azure.sqlserver
        filters:
          - type: firewall-bypass
            mode: equal
            list:
                - AzureServices

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      list:
        items:
          enum:
          - AzureServices
        type: array
      mode:
        enum:
        - include
        - equal
        - any
        - only
      type:
        enum:
        - firewall-bypass
    required:
    - mode
    - list
    - type




Actions
-------


  - :ref:`auto-tag-date <azure.common.actions.auto-tag-date>`
  
  - :ref:`auto-tag-user <azure.common.actions.auto-tag-user>`
  
  - :ref:`delete <azure.common.actions.delete>`
  
  - :ref:`lock <azure.common.actions.lock>`
  
  - :ref:`logic-app <azure.common.actions.logic-app>`
  
  - :ref:`mark-for-op <azure.common.actions.mark-for-op>`
  
  - :ref:`notify <azure.common.actions.notify>`
  
  - :ref:`set-firewall-rules <azure.sqlserver.actions.set-firewall-rules>`

  - :ref:`tag <azure.common.actions.tag>`
  
  - :ref:`tag-trim <azure.common.actions.tag-trim>`
  
  - :ref:`untag <azure.common.actions.untag>`
  
  - :ref:`webhook <azure.common.actions.webhook>`
  



.. _azure.sqlserver.actions.set-firewall-rules:

set-firewall-rules
++++++++++++++++++
Set Firewall Rules Action

Updates SQL Server Firewall configuration.

By default the firewall rules are replaced with the new values.  The ``append``
flag can be used to force merging the new rules with the existing ones on
the resource.

You may also reference azure public cloud Service Tags by name in place of
an IP address.  Use ``ServiceTags.`` followed by the ``name`` of any group
from https://www.microsoft.com/en-us/download/details.aspx?id=56519.

.. code-block:: yaml

    - type: set-firewall-rules
          bypass-rules:
              - AzureServices
          ip-rules:
              - 11.12.13.0/16
              - ServiceTags.AppService.CentralUS


:example:

Configure firewall to allow:
- Azure Services
- Two IP ranges

.. code-block:: yaml

    policies:
        - name: add-sql-server-firewall
          resource: azure.sqlserver
          actions:
            - type: set-firewall-rules
              bypass-rules:
                  - AzureServices
              ip-rules:
                  - 11.12.13.0/16
                  - 21.22.23.24

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      append:
        default: true
        type: boolean
      bypass-rules:
        items:
          enum:
          - AzureServices
        type: array
      ip-rules:
        items:
          type: string
        type: array
      prefix:
        maxLength: 91
        type: string
      type:
        enum:
        - set-firewall-rules
      virtual-network-rules:
        items:
          type: string
        type: array
    required:
    - type

