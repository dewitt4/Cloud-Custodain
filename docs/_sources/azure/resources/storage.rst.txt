.. _azure.storage:

azure.storage
=============

Storage Account Resource

:example:

Finds all Storage Accounts in the subscription.

.. code-block:: yaml

    policies:
        - name: find-all-storage-accounts
          resource: azure.storage

Filters
-------


  - :ref:`cost <azure.common.filters.cost>`
  
  - :ref:`event <azure.common.filters.event>`
  
  - :ref:`firewall-rules <azure.common.filters.firewall-rules>`
  
  - :ref:`marked-for-op <azure.common.filters.marked-for-op>`
  
  - :ref:`metric <azure.common.filters.metric>`
  
  - :ref:`offhour <azure.common.filters.offhour>`
  
  - :ref:`onhour <azure.common.filters.onhour>`
  
  - :ref:`policy-compliant <azure.common.filters.policy-compliant>`
  
  - :ref:`resource-lock <azure.common.filters.resource-lock>`
  
  - :ref:`storage-diagnostic-settings <azure.common.filters.storage-diagnostic-settings>`
  
  - :ref:`value <azure.common.filters.value>`
  




Actions
-------


  - :ref:`auto-tag-date <azure.common.actions.auto-tag-date>`
  
  - :ref:`auto-tag-user <azure.common.actions.auto-tag-user>`
  
  - :ref:`delete <azure.common.actions.delete>`
  
  - :ref:`lock <azure.common.actions.lock>`
  
  - :ref:`logic-app <azure.common.actions.logic-app>`
  
  - :ref:`mark-for-op <azure.common.actions.mark-for-op>`
  
  - :ref:`notify <azure.common.actions.notify>`
  
  - :ref:`set-log-settings <azure.storage.actions.set-log-settings>`

  - :ref:`set-network-rules <azure.storage.actions.set-network-rules>`

  - :ref:`tag <azure.common.actions.tag>`
  
  - :ref:`tag-trim <azure.common.actions.tag-trim>`
  
  - :ref:`untag <azure.common.actions.untag>`
  
  - :ref:`webhook <azure.common.actions.webhook>`
  



.. _azure.storage.actions.set-log-settings:

set-log-settings
++++++++++++++++
Action that updates the logging settings on storage accounts. The action requires
specifying an array of storage types that will be impacted by the action (blob, queue, table),
retention (number in days; 0-365), and an array of log settings to enable (read, write, delete).
The action will disable any settings not listed (e.g. by providing log: [write, delete], the
action will disable read).

 :example:

    Enable write and delete logging and disable read logging on blob storage,
    and retain logs for 5 days.

 .. code-block:: yaml

    policies:
        - name: enable-blob-storage-logging
          resource: azure.storage
          actions:
            - type: set-log-settings
              storage-types: [blob]
              retention: 5
              log: [write, delete]

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      log:
        items:
          enum:
          - read
          - write
          - delete
          type: string
        type: array
      retention:
        type: number
      storage-types:
        items:
          enum:
          - blob
          - queue
          - table
          type: string
        type: array
      type:
        enum:
        - set-log-settings
    required:
    - storage-types
    - log
    - retention
    - type


.. _azure.storage.actions.set-network-rules:

set-network-rules
+++++++++++++++++
Set Network Rules Action

Updates Azure Storage Firewalls and Virtual Networks settings.

:example:

Find storage accounts without any firewall rules.

Configure default-action to ``Deny`` and then allow:
- Azure Logging and Metrics services
- Two specific IPs
- Two subnets

.. code-block:: yaml

    policies:
        - name: add-storage-firewall
          resource: azure.storage

        filters:
            - type: value
              key: properties.networkAcls.ipRules
              value_type: size
              op: eq
              value: 0

        actions:
            - type: set-network-rules
              default-action: Deny
              bypass: [Logging, Metrics]
              ip-rules:
                  - ip-address-or-range: 11.12.13.14
                  - ip-address-or-range: 21.22.23.24
              virtual-network-rules:
                  - virtual-network-resource-id: <subnet_resource_id>
                  - virtual-network-resource-id: <subnet_resource_id>

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      bypass:
        items:
          enum:
          - AzureServices
          - Logging
          - Metrics
        type: array
      default-action:
        enum:
        - Allow
        - Deny
      ip-rules:
        items:
          ip-address-or-range:
            type: string
        type: array
      type:
        enum:
        - set-network-rules
      virtual-network-rules:
        items:
          virtual-network-resource-id:
            type: string
        type: array
    required:
    - default-action
    - type

