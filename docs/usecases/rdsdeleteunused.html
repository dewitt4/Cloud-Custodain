

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RDS - Delete Unused Databases With No Connections &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/c1_labs.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/expand.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Cloud Custodian  documentation" href="../index.html"/>
        <link rel="up" title="Use Cases" href="index.html"/>
        <link rel="next" title="RDS - Terminate Unencrypted Public Instances" href="rdspublicunencrypted.html"/>
        <link rel="prev" title="ELB - SSL Whitelist" href="elbsslwhitelist.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/advanced.html">Advanced Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart/offhours.html">Example offhours policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/tagCompliance.html">Example tag compliance policy</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="accountflowlog.html">Account - Flow Log Configuration Check</a></li>
<li class="toctree-l2"><a class="reference internal" href="accountinvalidiplogin.html">Account - Login From Invalid IP Address</a></li>
<li class="toctree-l2"><a class="reference internal" href="accountrootlogin.html">Account - Detect Root Logins</a></li>
<li class="toctree-l2"><a class="reference internal" href="accountservicelimit.html">Account - Service Limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="amicomp.html">AMI - Stop EC2 using Unapproved AMIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="asginvalidconfig.html">AutoScaling Group - Verify ASGs have valid configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="asgoffhours.html">ASG - Offhours Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebsgarbagecollect.html">EBS - Garbage Collect Unattached Volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebssnapshots.html">EBS - Create and Manage Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebsunencrypted.html">EBS - Delete Unencrypted</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2-auto-tag-user.html">EC2 - auto-tag aws userName on resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2offhours.html">EC2 - Offhours Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2oldinstances.html">EC2 - Old Instance Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2poweronstoppedforpatching.html">EC2 - Power On For Scheduled Patching</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2unpatchedworkflow.html">EC2 - Terminate Unpatchable Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbdeleteinetfacing.html">ELB - Delete New Internet-Facing ELBs</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbgarbagecollection.html">ELB - Delete Unused Elastic Load Balancers</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbsslblacklist.html">ELB - SSL Blacklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbsslwhitelist.html">ELB - SSL Whitelist</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">RDS - Delete Unused Databases With No Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="rdspublicunencrypted.html">RDS - Terminate Unencrypted Public Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3encryption.html">S3 - Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3globalgrants.html">S3 - Global Grants</a></li>
<li class="toctree-l2"><a class="reference internal" href="securitygroupsdetectremediate.html">Security Groups - Detect and Remediate Violations</a></li>
<li class="toctree-l2"><a class="reference internal" href="tagcompliance.html">Tag Compliance Across Resources (EC2, ASG, ELB, S3, etc)</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Working with AWS Lambda</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Policies reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../policy/index.html">Resource-Specific Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/tests.html">Testing for Developers</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../generated/modules.html">c7n</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Custodian</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Use Cases</a> &raquo;</li>
        
      <li>RDS - Delete Unused Databases With No Connections</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rds-delete-unused-databases-with-no-connections">
<span id="rdsdeleteunused"></span><h1>RDS - Delete Unused Databases With No Connections<a class="headerlink" href="#rds-delete-unused-databases-with-no-connections" title="Permalink to this headline">¶</a></h1>
<p>The following example policy workflow uses the mark-for-op and marked-for-op filters and
actions to chain together a set of policies to accomplish a task.  In this example it
will find any RDS that is older than 14 days that has had no connections to it in the last
14 days and tag it with a delete op and date 14 days out. The policy workflow will also
email the RDS resource owner to inform them of the upcoming stopping and deletion if the
RDS remains unused. If a customer connects to the RDS before the 14 day window it will
get unmarked so it doesn’t get deleted.</p>
<p>Note the use of the notify action requires the Cloud Custodian mailer to be installed
and configured.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">metrics-filters</span><span class="p p-Indicator">:</span> <span class="nl">&amp;metrics-filter</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DatabaseConnections</span>
        <span class="l l-Scalar l-Scalar-Plain">days</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">equal</span>

<span class="l l-Scalar l-Scalar-Plain">policies</span><span class="p p-Indicator">:</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-notify-step1</span>
  <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 14 days for databases that are greater than 14</span>
    <span class="no">days old and notify the resources owner on any unused RDS and mark for delete action in 14 days.</span>
  <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">greater-than</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mark-for-op</span>
      <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="l l-Scalar l-Scalar-Plain">days</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="l l-Scalar l-Scalar-Plain">priority_header</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">Instance</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">had</span><span class="nv"> </span><span class="s">no</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">weeks</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">unused:&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken:  Database deletion has been scheduled for 14 days from now.</span>
          <span class="no">At this point we are just notifying you of the upcoming deletion if not used.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-notify-step2</span>
  <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 21</span>
    <span class="no">days and notify on any unused RDS that have already been marked for delete</span>
  <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="l l-Scalar l-Scalar-Plain">skew</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">21</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="l l-Scalar l-Scalar-Plain">priority_header</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance has had no connections in the last 3 weeks and is unused and will be stopped</span>
          <span class="no">hourly in 5 days (if supported by DB type) and then deleted 2 days after its stopped:&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken:  Hourly database stopping and email will occur in 5 days and deleted will occur in 7 days.</span>
          <span class="no">At this point we are just notifying you of the upcoming stoppage and deleted if not used&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-stop-and-nag-hourly-step3</span>
  <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">periodic</span>
      <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&quot;rate(1</span><span class="nv"> </span><span class="s">hour)&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">300</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">This policy deploys a Lambda function with an hourly CloudWatch Event Schedule trigger.</span>
    <span class="no">The policy takes the average number of connections over 26 days and stops the RDS and</span>
    <span class="no">notifies the resource owner hourly on any of their unused databases that have already</span>
    <span class="no">been marked for deletion.</span>
  <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="l l-Scalar l-Scalar-Plain">skew</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">26</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="l l-Scalar l-Scalar-Plain">priority_header</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT!!!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance has had no connections in the last 26 days and is unused</span>
          <span class="no">and will be deleted in less than 48 hours&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken: Hourly Stopping of RDS and notify.  Deletion will occur in less than</span>
          <span class="no">48 hours. Please connect to the RDS or snapshot it if you don&#39;t need it at this time.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-delete-step4</span>
  <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 28 days and delete</span>
    <span class="no">any unused databases that have already been marked for delete</span>
  <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">28</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="l l-Scalar l-Scalar-Plain">skip-snapshot</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="l l-Scalar l-Scalar-Plain">priority_header</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT!!!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">Deleted!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">Instance</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">had</span><span class="nv"> </span><span class="s">no</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">28</span><span class="nv"> </span><span class="s">days</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">deleted.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="s">&quot;Actions</span><span class="nv"> </span><span class="s">Taken:</span><span class="nv"> </span><span class="s">RDS</span><span class="nv"> </span><span class="s">Instance(s)</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">deleted.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-unmark</span>
  <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">The policy takes the average number of connections over 14 days and if there are connections</span>
    <span class="no">then unmark the RDS instance and notify the resource owner.</span>
  <span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="l l-Scalar l-Scalar-Plain">value_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DatabaseConnections</span>
      <span class="l l-Scalar l-Scalar-Plain">days</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
      <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gt</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">or</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unmark</span>
      <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;c7n_rds_unused&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="l l-Scalar l-Scalar-Plain">priority_header</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Previously</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">DB</span><span class="nv"> </span><span class="s">Unmarked!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance that previously had no connections for over 2 weeks is now showing</span>
          <span class="no">connections and it has been unmarked for deletion.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="s">&quot;Actions</span><span class="nv"> </span><span class="s">Taken:</span><span class="nv"> </span><span class="s">RDS</span><span class="nv"> </span><span class="s">Instance(s)</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">unmarked.</span><span class="nv"> </span><span class="s">No</span><span class="nv"> </span><span class="s">further</span><span class="nv"> </span><span class="s">action</span><span class="nv"> </span><span class="s">needed&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rdspublicunencrypted.html" class="btn btn-neutral float-right" title="RDS - Terminate Unencrypted Public Instances" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="elbsslwhitelist.html" class="btn btn-neutral" title="ELB - SSL Whitelist" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/js/expand.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>