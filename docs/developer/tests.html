

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testing for Developers &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/c1_labs.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/expand.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Cloud Custodian  documentation" href="../index.html"/>
        <link rel="next" title="c7n" href="../generated/modules.html"/>
        <link rel="prev" title="Installing for Developers" href="installing.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/advanced.html">Advanced Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/offhours.html">Example offhours policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/tagCompliance.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecases/index.html">Use Cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AWS Lambda</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Policies reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../policy/index.html">Resource-Specific Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing for Developers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing for Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-tests">Running tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ratcheting-down-python-3-6-tests">Ratcheting down Python 3.6 Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decorating-tests">Decorating tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-placebo-tests">Writing Placebo Tests</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../generated/modules.html">c7n</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Custodian</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Testing for Developers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing-for-developers">
<span id="developer-tests"></span><h1>Testing for Developers<a class="headerlink" href="#testing-for-developers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>Unit tests can be run with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ tox
</pre></div>
</div>
<p>Coverage reports can be generated and viewed with the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>py27<span class="o">)</span> $ make coverage

<span class="c1"># Open the reports in a browser</span>

<span class="c1"># on osx</span>
$ open coverage/index.html

<span class="c1"># on gnomeish linux</span>
$ gnome-open coverage/index.html
</pre></div>
</div>
</div>
<div class="section" id="ratcheting-down-python-3-6-tests">
<h2>Ratcheting down Python 3.6 Tests<a class="headerlink" href="#ratcheting-down-python-3-6-tests" title="Permalink to this headline">¶</a></h2>
<p>We are in the process of porting Custodian to run on both Python 3.6 in
addition to 2.7. As part of this process, we record tests that are known to
fail under Python 3.6 in a file called <code class="docutils literal"><span class="pre">ratchet.txt</span></code>, and we require these
and only these tests to fail under the <code class="docutils literal"><span class="pre">py36</span></code> environment during continuous
integration. If you make changes that fix some failing tests under Python 3.6,
then the <code class="docutils literal"><span class="pre">py36</span></code> test environment will remove the newly pasing tests from the
<code class="docutils literal"><span class="pre">ratchet.txt</span></code> file and will fail with a message prompting you to commit the
changes to <code class="docutils literal"><span class="pre">ratchet.txt</span></code>.</p>
</div>
<div class="section" id="decorating-tests">
<h2>Decorating tests<a class="headerlink" href="#decorating-tests" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">functional</span></code> decorator marks tests that don’t require any pre-existing
AWS context, and can therefore be run cleanly against live AWS.</p>
</div>
<div class="section" id="writing-placebo-tests">
<h2>Writing Placebo Tests<a class="headerlink" href="#writing-placebo-tests" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="http://placebo.readthedocs.io/en/latest/">Placebo</a> library is used to
record and replay AWS responses so that tests can run locally, and in a fraction
of the time it would take to interact with live AWS services.</p>
<p>In order to write a placebo test two helper methods are provided:</p>
<blockquote>
<div><ul class="simple">
<li><cite>record_flight_data</cite> - use this when creating the test</li>
<li><cite>replay_flight_data</cite> - use this when the test is completed</li>
</ul>
</div></blockquote>
<p>When first creating a test, use the <cite>record_flight_data</cite> method.  This will
contact AWS and store all responses as files in the placebo directory
(<cite>tests/data/placebo/</cite>).  The method takes one parameter, which is the directory
name to store placebo output in and it must be unique across all tests.  For
example:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">    <span class="n">session_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_flight_data</span><span class="p">(</span>
</span><span class="hll">        <span class="s1">&#39;test_example&#39;</span><span class="p">)</span>
</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;list-ec2-instances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;ec2&#39;</span>
    <span class="p">}</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_policy</span><span class="p">(</span>
        <span class="n">policy</span><span class="p">,</span>
        <span class="n">session_factory</span><span class="o">=</span><span class="n">session_factory</span><span class="p">)</span>

    <span class="n">resources</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resources</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Now run this test using the following command to generate the placebo data:</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span></span>$ nosetests -s -v tests/path/to/test.py
</pre></div>
</div>
</div></blockquote>
<p>This may take a little while as the test is contacting AWS.
All responses are stored in the placebo dir, and can be viewed when the test is
finished.  It is not necessary to inspect these files, but they can be helpful
if the test is not behaving how you expect.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span></span>$ ls tests/data/placebo/test_example/
ec2.DescribeInstances_1.json
ec2.DescribeTags_1.json
</pre></div>
</div>
</div></blockquote>
<p>If it is necessary to run the test again - for example, if the test fails, or if
it is not yet fully complete - you can run with <cite>record_flight_data</cite> as many
times as necessary.  The contents of the directory will be cleared each time the
test is run while <cite>record_flight_data</cite> is in place.</p>
<p>When the test is completed, change to using <cite>replay_flight_data</cite>:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">    <span class="n">session_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_flight_data</span><span class="p">(</span>
</span><span class="hll">        <span class="s1">&#39;test_example&#39;</span><span class="p">)</span>
</span>
    <span class="o">...</span>
</pre></div>
</div>
</div></blockquote>
<p>Now when the test is run it will use the data previously recorded and will not
contact AWS.  When committing your test, don’t forget to include the
<cite>tests/data/placebo/test_example</cite> directory!</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../generated/modules.html" class="btn btn-neutral float-right" title="c7n" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installing.html" class="btn btn-neutral" title="Installing for Developers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/js/expand.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>